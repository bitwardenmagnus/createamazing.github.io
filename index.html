<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minecraft Server starten</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; max-width: 700px; margin: auto; }
    .row { margin-bottom: 12px; }
    button { padding: 10px 16px; font-weight: 600; cursor: pointer; }
    .status { margin-top: 16px; }
    .hidden { display: none; }
    input { padding: 8px; width: 100%; max-width: 420px; }
    label { font-weight: 600; }
    .note { color: #666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Server starten</h1>

  <p class="note">Dieses Tool löst das Cloudflare Turnstile (Invisible) aus und sendet einen Start-Request an FalixNodes.</p>

  <div class="row">
    <label for="address">Server-Adresse (Host oder Host:Port)</label><br />
    <input id="address" type="text" placeholder="z. B. createamazing.falixsrv.me:26468" value="createamazing.falixsrv.me:26468" />
  </div>

  <div class="row">
    <button id="startBtn">Server jetzt starten</button>
  </div>

  <div id="status" class="status"></div>

  <!-- Invisible Turnstile widget (non-interactive, pre-clearance) -->
  <div style="height:0;width:0;overflow:hidden;">
    <div id="cf-turnstile"
         class="cf-turnstile"
         data-sitekey="0x4AAAAAAB0B7uEwc5zscEyP"
         data-callback="onTurnstileSuccess"
         data-error-callback="onTurnstileError"
         data-before-interactive="true"
         data-size="invisible"
         data-refresh-expired="auto"
         data-refresh-timeout="auto">
    </div>
  </div>

  <script>
    const WORKER_ENDPOINT = 'https://still-hall-d6b4.ultimativergamer173.workers.dev/start';

    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const addressEl = document.getElementById('address');

    let pendingStartPayload = null;

    function setStatus(msg, ok = false) {
      statusEl.textContent = msg;
      statusEl.style.color = ok ? '#0a7d00' : '#b00020';
    }

    function clearStatus() {
      statusEl.textContent = '';
    }

    function normalizeAddress(raw) {
      const s = (raw || '').trim();
      if (!s) return null;
      // If no port provided, default to 25565; override if your FalixNodes expects explicit port.
      if (s.includes(':')) return s;
      return s + ':25565';
    }

    startBtn.addEventListener('click', async () => {
      clearStatus();
      const addr = normalizeAddress(addressEl.value);
      if (!addr) {
        setStatus('Bitte eine gültige Server-Adresse eingeben (Host oder Host:Port).');
        return;
      }
      startBtn.disabled = true;
      startBtn.textContent = 'Arbeite...';
      pendingStartPayload = { address: addr };
      try {
        // Trigger invisible Turnstile
        if (window.turnstile && document.getElementById('cf-turnstile')) {
          turnstile.execute(document.getElementById('cf-turnstile'));
        } else {
          setStatus('Turnstile konnte nicht initialisiert werden.');
          startBtn.disabled = false;
          startBtn.textContent = 'Server jetzt starten';
        }
      } catch (e) {
        setStatus('Fehler beim Ausführen von Turnstile.');
        startBtn.disabled = false;
        startBtn.textContent = 'Server jetzt starten';
      }
    });

    // Called by Turnstile on success
    async function onTurnstileSuccess(token) {
      if (!pendingStartPayload) return;
      try {
        const res = await fetch(WORKER_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'omit',
          body: JSON.stringify({
            address: pendingStartPayload.address,
            cfTurnstileToken: token,
          }),
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { ok: res.ok, message: text }; }

        if (res.ok) {
          setStatus(data.message || 'Serverstart ausgelöst.', true);
        } else {
          setStatus(data.error || data.message || 'Start fehlgeschlagen.');
        }
      } catch (e) {
        setStatus('Netzwerkfehler beim Start-Request.');
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'Server jetzt starten';
        pendingStartPayload = null;
        // Reset token so next click gets a fresh one
        try { turnstile.reset(document.getElementById('cf-turnstile')); } catch {}
      }
    }

    // Called by Turnstile on error
    function onTurnstileError() {
      setStatus('Turnstile-Validierung fehlgeschlagen.');
      startBtn.disabled = false;
      startBtn.textContent = 'Server jetzt starten';
      pendingStartPayload = null;
      try { turnstile.reset(document.getElementById('cf-turnstile')); } catch {}
    }

    // Expose callbacks globally
    window.onTurnstileSuccess = onTurnstileSuccess;
    window.onTurnstileError = onTurnstileError;
  </script>
</body>
</html>
