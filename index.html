<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minecraft Server starten</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; max-width: 700px; margin: auto; }
    .row { margin-bottom: 12px; }
    button { padding: 10px 16px; font-weight: 600; cursor: pointer; }
    .status { margin-top: 16px; }
    input { padding: 8px; width: 100%; max-width: 420px; }
    label { font-weight: 600; }
    .note { color: #666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Server starten</h1>
  <p class="note">Startet deinen Server über FalixNodes. Turnstile läuft unsichtbar im Hintergrund.</p>

  <div class="row">
    <label for="address">Server-Host oder IP (ohne Port)</label><br />
    <input id="address" type="text" placeholder="z. B. createamazing.falixsrv.me oder 85.10.204.233" value="createamazing.falixsrv.me" />
  </div>

  <div class="row">
    <button id="startBtn">Server jetzt starten</button>
  </div>

  <div id="status" class="status"></div>

  <div style="height:0;width:0;overflow:hidden;">
    <div id="cf-turnstile"
         class="cf-turnstile"
         data-sitekey="0x4AAAAAAB0B7uEwc5zscEyP"
         data-callback="onTurnstileSuccess"
         data-error-callback="onTurnstileError"
         data-before-interactive="true"
         data-size="invisible"
         data-refresh-expired="auto"
         data-refresh-timeout="auto">
    </div>
  </div>

  <script>
    const WORKER_ENDPOINT = 'https://still-hall-d6b4.ultimativergamer173.workers.dev/start';
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const addressEl = document.getElementById('address');
    let pendingStartPayload = null;

    function setStatus(msg, ok = false) {
      statusEl.textContent = msg;
      statusEl.style.color = ok ? '#0a7d00' : '#b00020';
    }

    startBtn.addEventListener('click', () => {
      const raw = (addressEl.value || '').trim();
      if (!raw || raw.includes(':')) {
        setStatus('Bitte Host oder IP ohne Port eingeben.');
        return;
      }
      pendingStartPayload = { address: raw };
      startBtn.disabled = true;
      startBtn.textContent = 'Arbeite...';
      try { turnstile.execute(document.getElementById('cf-turnstile')); }
      catch { setStatus('Turnstile konnte nicht gestartet werden.'); startBtn.disabled = false; startBtn.textContent = 'Server jetzt starten'; }
    });

    async function onTurnstileSuccess(token) {
      if (!pendingStartPayload) return;
      try {
        const res = await fetch(WORKER_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: pendingStartPayload.address, cfTurnstileToken: token }),
        });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = { ok: res.ok, message: text }; }
        if (res.ok) setStatus(data.message || 'Serverstart ausgelöst.', true);
        else setStatus(data.error || data.message || 'Start fehlgeschlagen.');
      } catch {
        setStatus('Netzwerkfehler.');
      } finally {
        pendingStartPayload = null;
        startBtn.disabled = false;
        startBtn.textContent = 'Server jetzt starten';
        try { turnstile.reset(document.getElementById('cf-turnstile')); } catch {}
      }
    }
    function onTurnstileError() {
      setStatus('Turnstile-Validierung fehlgeschlagen.');
      pendingStartPayload = null;
      startBtn.disabled = false;
      startBtn.textContent = 'Server jetzt starten';
      try { turnstile.reset(document.getElementById('cf-turnstile')); } catch {}
    }
    window.onTurnstileSuccess = onTurnstileSuccess;
    window.onTurnstileError = onTurnstileError;
  </script>
</body>
</html>
